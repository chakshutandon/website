stages:
  - build
  - deploy

image: alpine:3.13.6

variables:
  HUGO_VERSION: 0.88.1
  FIREBASE_VERSION: 9.18.0
  BIN_DIR: /usr/local/bin

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - ${BIN_DIR}

install:
  stage: build
  script:
    - apk update && apk add curl
    - curl -L -o /tmp/hugo.tar.gz https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_Linux-64bit.tar.gz
    - mkdir /tmp/hugo; tar -xvf /tmp/hugo.tar.gz -C /tmp/hugo; mv /tmp/hugo/hugo ${BIN_DIR}/hugo; chmod +x ${BIN_DIR}/hugo
    - curl -L -o ${BIN_DIR}/firebase https://firebase.tools/bin/linux/v${FIREBASE_VERSION}
    - chmod +x ${BIN_DIR}/firebase

build:
  stage: build
  script:
    - hugo
  needs:
    - install
  artifacts:
    paths: ['public']
    expire_in: 2 hrs

deploy:staging:
  stage: deploy
  environment:
    name: staging
  script:
    - firebase
  needs:
    - install
    - build
  # only:
  #   - master

# staging:
#   stage: deploy
#   environment:
#     name: staging
#   only:
#     - master
#   image: node:alpine
#   dependencies:
#     - build
#   script:
#     - npm install -g firebase-tools
#     - firebase use staging --token $FIREBASE_DEPLOY_KEY
#     - firebase deploy -m "Pipeline $CI_PIPELINE_ID, Job $CI_JOB_ID" --non-interactive --token $FIREBASE_DEPLOY_KEY

# prod:
#   stage: deploy
#   environment:
#     name: prod
#   when: manual
#   only:
#     - master
#   image: node:alpine
#   dependencies:
#     - build
#   script:
#     - npm install -g firebase-tools
#     - firebase use production --token $FIREBASE_DEPLOY_KEY
#     - firebase deploy -m "Pipeline $CI_PIPELINE_ID, Job $CI_JOB_ID" --non-interactive --token $FIREBASE_DEPLOY_KEY
